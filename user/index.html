<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width"/>
    <title>new scratchstats</title>
    <link rel="icon" href="https://scratchstats.f5.si/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="https://scratchstats.f5.si/apple-touch-icon-180x180.png">
    <link rel="icon_iphone" href="https://scratchstats.f5.si/favicon.ico">
    <style>
      body {
        background-color: #DDEEFF;
      }
      
      .header {
        background-color: #4e97fe;
        position: fixed;
        top: 0px;
        left: 0px;
        width: 100%;
        text-align: center;
        height: 50px;
        margin-left: -10px;
        z-index: 998;
      }
      
      .headertext {
        color: #fcfcfc;
        position: fixed;
        top: 0;
        text-align: center;
        width: 100%;
        z-index: 999;
        margin-top: -20px;
        margin-left: -8px;
        font-family: sans-serif;
        background-color: #4e97fe;
      }

      .icon {
        display: block;      /* ★これによってブロック要素になります */
        margin: 80px auto 0 auto;
        border-radius: 10px;
        width: 100px;
        height: 100px;
      }

      .favoritesandloves {
        border: 1px solid #0066CC;
        border-radius: 10px;
        background-color: #EEEEFF;
        margin-top: 110px;
        display: flex;
        align-items: center;
        gap: 3px;
        justify-content: center;
        height: 50px;
      }

      .favorites,
      .loves {
        height: 30px;
        width: 30px;
      }

      #logcheck {
        margin-top: 60px;
        margin-right: 0px;
        position: absolute;
        top: 15px;
      }

      .log {
        width: 20%;
        height: 100%;
        margin-top: 0px;
        text-align: left;
        background-color: #DDEEFF;
        border: 1px solid #0066CC;
        position: fixed;
        top: 50px;
        right: 0;
      }

      .favorites-info {
        display: flex;
        align-items: center;
        margin-right: 50px;
      }
      
      .loves-info {
        display: flex;
        align-items: center;
        margin-left: 50px;
      }
      
      .favoritestxt,
      .lovestxt,
      #favoritestext,
      #lovestext {
        /* テキストのスタイル調整 */
         margin: 0; /* デフォルトのマージンをリセット */
         white-space: nowrap; /* テキストの折り返しを防ぐ */
      }
    </style>
  </head>
  <body>
    <input type="checkbox" id="logcheck" name="logcheck" />
    <div id="log" class="log" style="display: none;"><aside><p>log:</p></aside></div>
    <div class="header"></div><div class="headertext"><span onclick="header()"><h1>新 scratch stats</h1></span></div>
    <div id="image"><img src="https://scratchstats.f5.si/images/first_icon.png" alt="icon" class="icon" /></div>
    <div class="favoritesandloves"><div class="favorites-info"><img src="https://scratchstats.f5.si/images/favorites.svg" alt="favorites" class="favorites" /><p class="favoritestxt">をつけた数:</p><p id="favoritestext">-</p></div><img src="https://scratchstats.f5.si/images/loves.svg" alt="loves" class="loves" /><p class="lovestxt">をつけた数:</p><p id="lovestext">-</p></div>
    <script>
      let data;

      function log(log) {
        // id属性で要素を取得
        let textbox_element = document.getElementById('log');

        // 新しいHTML要素を作成
        let new_element = document.createElement('p');
        new_element.textContent = log;

        // 指定した要素の中の末尾に挿入
        textbox_element.appendChild(new_element);
      
      }
      
      function header() {
        window.location.href = `https://scratchstats.f5.si/`;
      }

      function error() {
        alert("リクエスト中にエラーが発生しました");
      }
      
      window.onload = function() {
        log("1");
        document.getElementById('logcheck').addEventListener('change', function() {
          const log = document.querySelector('.log');
          if (this.checked) {
            log.style.display = 'block';
          } else {
            log.style.display = 'none';
          }
        });
        log("2");
        const url = new URL(window.location.href);
        const my_param = new URLSearchParams(url.search);
        const user = my_param.get('user');
        log(user);
        fetch(`https://api.scratchstats.f5.si/user?user=${user}`)
        .then(response => {
          // HTTPレスポンスが成功したかどうか（ステータスコード200-299）を確認
          if (!response.ok) {
            throw new Error(`HTTP エラー! ステータス: ${response.status} - ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          log("3: APIレスポンスを受信し、パースしました。");
          log(`APIデータ: ${JSON.stringify(data)}`); // 検証のために受信した全データをログに出力

          if (data && data.id) {
            document.getElementById('image').innerHTML = `<img src="https://uploads.scratch.mit.edu/get_image/user/${data.id}_300x300.png" alt="icon" class="icon" />`;
          } else {
            log("エラー: APIレスポンスにユーザーIDが含まれていません。");
            errorAlert("ユーザーIDが見つかりませんでした。");
          }

          // お気に入りと愛の数を更新（データが存在する場合）
          if (data.favorites_count !== undefined) {
              document.getElementById('favoritestext').textContent = data.favorites_count;
          }
          if (data.loves_count !== undefined) {
              document.getElementById('lovestext').textContent = data.loves_count;
          }
        })
        .catch(error => {
          // fetchが失敗した場合、特定のエラーメッセージをログに出力
          log(`フェッチエラー: ${error.message}`); 
          errorAlert(error.message); // エラーメッセージをアラート関数に渡す
        });
      }
    </script>
  </body>
</html>
